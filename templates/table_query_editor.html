<!DOCTYPE html>
<html>
<head>
	<title>Donkey Query Editor</title>
	<script src="{{prefix}}/static/jsoneditor.js"></script>
	<script src="{{prefix}}/static/jquery-2.1.4.min.js"></script>
	<script src="{{prefix}}/static/bootstrap-3.3.5/js/bootstrap.min.js"></script>
	<link href="{{prefix}}/static/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet">
	
</head>
<body>

<div class="container">
	<div class="row">
		<h1>Let's construct a Donkey Query!</h1>
	</div>
	
</div>
<!--Save query Modal-->
<div class="modal fade" id="saveModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Save a New Query</h4>
      </div>
      <div class="modal-body">
      		<p>
      			Before Continuing, make sure you have inserted all the parameters you want into your query, and that it is behaving as expected!
      		</p>
      		<hr>
      		<pre id="query_preview"></pre>
      		<hr>
      		<p>
      			If everything is correct, fill in the form and save the query
      		</p>
      		<form id="saveForm">
      			<div class="form-group">
	      			<label for="q_name">Query Name</label>
	      			<input type="name" class="form-control" id="q_name" placeholder="Query Name">
      			</div>
      			<div class="form-group">
      				<label for="q_description">Query Description</label>
      				<input type="description" class="form-control" id="q_description" placeholder="Query Description">
      			</div>
      			<div class="form-group">
      				<label for="q_parameters">Query Parameters</label>
      				<input type="parameters" class="form-control" id="q_parameters" placeholder="Comma-seperated list of parameters e.g. url,isbn,etc...">
      			</div>      			
      		</form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="saveQuery">Save Query</button>
      </div>
    </div>
  </div>	
</div>

<script type="text/javascript">
function hit_api(route, data, method){
	var res;
	$.ajax({
		type:method,
		contentType:'application/json',
		url:"{{prefix}}" + route,
		data:JSON.stringify(data),
		async:false,
		success: function(data) {
			res = data;
		},
	});
	return res;	
};

function get_raw_data(){
	return hit_api(
		'/query/raw_data/' + uuid,
		{},
		'GET'
		).raw_data
};

function get_data(){
	return hit_api(
		'/query/data/' + uuid,
		{},
		'GET'
		).data
};

function get_handle_query(){
	return hit_api(
		'/query/handle_query/' + uuid,
		{},
		'GET'
		).handle_query
};

function get_request_query(){
	return hit_api(
		'/query/request_query/' + uuid,
		{},
		'GET'
		).request_query
};

function query_fetch(data){
	return hit_api(
		'/query/fetch/' + uuid,
		data,
		'POST'
		)
};

function query_handle(data){
	return hit_api(
		'/query/handle/' + uuid,
		data,
		'POST'
		)
};

function query_run(data){
	return hit_api(
		'/query/run/' + uuid,
		data,
		'POST'
		)
};


function hydrate_query(uuid){
	return {
		raw_data:get_raw_data(uuid),
		data:get_data(uuid),
		handle_query: get_handle_query(uuid),
		request_query:get_request_query(uuid),
	}
};




uuid = "{{uuid}}";
console.log(uuid);


if (uuid == 'NEW_QUERY') {
	q_data = hit_api('/query/new/',{handler:"XPATHROW"}, 'POST');
	console.log(q_data);
	uuid = q_data.uuid;
	query = hydrate_query(uuid);
	console.log(query)

};
</script>
</body>
</html>